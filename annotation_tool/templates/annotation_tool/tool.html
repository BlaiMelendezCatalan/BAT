{% load staticfiles %}
<html>
<head>
  <link rel="stylesheet" type="text/css" href="{% static 'css/annotator/urban-ears.css' %}"/>
  <link rel="stylesheet" type="text/css" href="{% static 'css/annotator/materialize.min.css' %}"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <script type="text/javascript" src="{% static 'js/annotator/lib/jquery-2.2.3.min.js' %}"></script>
  <script type="text/javascript" src="{% static 'js/annotator/lib/materialize.min.js' %}"></script>
  <script type="text/javascript" src="{% static 'js/annotator/lib/wavesurfer.min.js' %}"></script>
  <script type="text/javascript" src="{% static 'js/annotator/lib/wavesurfer.spectrogram.min.js' %}"></script>
  <script type="text/javascript" src="{% static 'js/annotator/colormap/colormap.min.js' %}"></script>

  <script type="text/javascript" src="{% static 'js/annotator/src/message.js' %}"></script>
  <script type="text/javascript" src="{% static 'js/annotator/src/wavesurfer.regions.js' %}"></script>
  <script type="text/javascript" src="{% static 'js/annotator/src/wavesurfer.drawer.extended.js' %}"></script>
  <script type="text/javascript" src="{% static 'js/annotator/src/wavesurfer.labels.js' %}"></script>
  <script type="text/javascript" src="{% static 'js/annotator/src/hidden_image.js' %}"></script>
  <script type="text/javascript" src="{% static 'js/annotator/src/components.js' %}"></script>
  <script type="text/javascript" src="{% static 'js/annotator/src/annotation_stages.js' %}"></script>
  {% comment %}<script type="text/javascript" src="{% static 'js/annotator/src/main.js' %}"></script>{% endcomment %}
</head>
<body>

<!-- Modal Structure -->
<div id="video-modal" class="modal">
  <div class="modal-content">
    <h4>Tutorial Video</h4>
    <div class="videowrapper">
      <iframe id="tutorial-video" width="100%" height="100%" frameborder="0" allowfullscreen></iframe>
    </div>
  </div>
  <div class="modal-footer">
    <a href="#!" class=" modal-action modal-close waves-effect waves-red btn-flat">Close</a>
  </div>
</div>
<div class="annotation">
  <div class="labels"></div>
  <div class="audio_visual"></div>
  <div class="play_bar"></div>
  <div class="hidden_img"></div>
  <div class="creation_stage_container"></div>
  <div class="submit_container"></div>
  <div>Class</div>
  <input type="text" id="show_class" value="" readonly>
  <div>Tags</div>
  <input type="text" id="tags" value="">
  <button id="tag_button">Save tags</button>
</div>
<script>
  {% comment %}  var dataUrl = '/static/json/sample_data.json';
    var postUrl = '/<post_url>'; // This is where data posts to

    $(document).ready(function () {
      $('.modal-trigger').leanModal();
    });{% endcomment %}
</script>

<script>

  function loadRegions() {
    // Do it with AJAX and return all info for all regions
    {% for event in events %}
      tags = []
      {% for tag in event.tags.all %}
        tags.push('{{ tag.name }}')
      {% endfor %}
      annotator.wavesurfer.addRegion({
        attributes: {
          'class': '{{ event.event_class }}',
          'tags': tags,
          'event_id': {{ event.id }},
          'loaded': true
        },
        start: {{ event.start_time }},
        end: {{ event.end_time }},
        color: '{{ event.color }}',
        drag: false,
      });
    {% endfor %}
  }


    function updateEvent(region) {
    	var region_data = {
        event_id: region.attributes['event_id'],
        color: region.color,
        start_time: region.start,
        end_time: region.end,
        event_class: region.attributes['class'],
        tags: region.attributes['tags']
      }
      console.log('in update event', region_data)

    	{% comment %}$.ajax({
            type: "POST",
            url: '../update_event/',
            dataType: 'json',
            data: { region_data: JSON.stringify(region_data),
            		csrfmiddlewaretoken: '{{csrf_token}}'},
            success: function(response) {}
        });{% endcomment %}
    }

  function getDuration() {
    return annotator.wavesurfer.getDuration() - 0.1;
  }

  function setCurrentRegion(id) {
    annotator.currentRegionId = id;
  }

  function disableDrag(region) {
    region.drag = false;
  }

  function resetHTML() {
    document.getElementById("tags").value = "";
    var select = document.getElementById("show_class");
    select.selectedIndex = 0;
  }

  function preventOverlappingsOnCreation(current_region) {
    var new_start = current_region.start;
    var new_end = current_region.end;
    if (new_end > getDuration()) {
      new_end = getDuration()
    }
    Object.keys(annotator.wavesurfer.regions.list).forEach(function (id) {
      var region = annotator.wavesurfer.regions.list[id];
      if (current_region.start < region.start && current_region.end > region.start) {
        console.log('WRONG END');
        new_end = region.start;
      } else if (current_region.end > region.end && current_region.start < region.end) {
        console.log('WRONG START');
        new_start = region.end;
      }
    });
    return [new_start, new_end];
  }

  function Annotator() {
    var that = this;
    // Create color map for spectrogram
    var spectrogramColorMap = colormap({
      colormap: magma,
      nshades: 256,
      format: 'rgb',
      alpha: 1
    });

    var height = 128;
    this.wavesurfer = WaveSurfer.create({
      container: '.audio_visual',
      waveColor: 'violet',
      progressColor: 'purple',
      fftSamples: height * 2,
      height: height,
      normalize: true,
      fillParent: true,
      hideScrollbar: true,
      colorMap: spectrogramColorMap
    });

    this.wavesurfer.load("{% url 'media' tmp_segment_path %}");

    // Create labels (labels that appear above each region)
    var labels = Object.create(WaveSurfer.Labels);
    labels.init({
      wavesurfer: this.wavesurfer,
      container: '.labels'
    });

    // Create the play button and time that appear below the wavesurfer
    this.playBar = new PlayBar(this.wavesurfer);
    this.playBar.create();

    // Create Workflow btns (submit and exit)
    this.workflowBtns = new WorkflowBtns();
    this.workflowBtns.create();


    this.class_dict = {{ class_dict|safe }};
    this.currentRegionId = -1;

    this.wavesurfer.on('ready', function () {
      that.wavesurfer.enableDragSelection({})
      loadRegions()
      that.wavesurfer.play()
    });

    // WaveSurfer callbacks
    this.wavesurfer.on('region-created', function (region) {
      console.log("created", region)
      setCurrentRegion(region.id)
      disableDrag(region)
      resetHTML()

      if (!('loaded' in region.attributes) && !('created' in region.attributes)) {
        console.log('region first_branch')
        region.attributes['class'] = "None"
        region.attributes['tags'] = []
      } else if ('loaded' in region.attributes) {
        console.log('region second_branch')
        delete region.attributes['loaded']
      } else if ('created' in region.attributes) {
        console.log('region THIRD_branch')
        delete region.attributes['created']
        var region_data = {}
        region_data['annotation'] = '{{ annotation }}'
        region_data['event_class'] = region.attributes['class']
        region_data['tags'] = region.attributes['tags']
        region_data['start_time'] = region.start
        region_data['end_time'] = region.end
        region_data['color'] = region.color
        console.log('region_data', region_data)
        {% comment %}
                    $.ajax({
                        type: "POST",
                        url: '../create_event/',
                        dataType: 'json',
                        data: { region_data: JSON.stringify(region_data),
                                csrfmiddlewaretoken: '{{csrf_token}}'},
                        success: function(data) {
                            region = wavesurfer.regions.list[currentRegionId]
                            region.attributes['event_id'] = data.event_id
                        }
                    });{% endcomment %}
      }
    });

    this.wavesurfer.on('region-update-end', function (region) {
      console.log("update-end", region);
      setCurrentRegion(region.id);
      var region_data = {};
      var times = preventOverlappingsOnCreation(region);
      region.update({
        start: times[0],
        end: times[1],
      });
      region_data['start_time'] = times[0];
      region_data['end_time'] = times[1];
      region_data['annotation'] = '{{ annotation }}';
      region_data['color'] = region.color;
      console.log('data', region_data);
      {% comment %}if ('event_id' in region.attributes) {
        region_data['event_id'] = region.attributes['event_id']
      }
          $.ajax({
              type: "POST",
              url: '../update_end_event/',
              dataType: 'json',
              data: { region_data: JSON.stringify(region_data),
                  csrfmiddlewaretoken: '{{csrf_token}}'},
              success: function(data) {
                region = wavesurfer.regions.list[currentRegionId]
          region.attributes['event_id'] = data.event_id
              }
          });{% endcomment %}
    });

    this.wavesurfer.on('region-updated', function (region) {
      console.log("updated")
    });


    this.wavesurfer.on('region-removed', function (region) {
      console.log("removed")
      setCurrentRegion(-1)
      var region_data = {'event_id': region.attributes['event_id']};

      {% comment %}$.ajax({
              type: "POST",
              url: '../remove_event/',
              dataType: 'json',
              data: { region_data: JSON.stringify(region_data),
                  csrfmiddlewaretoken: '{{csrf_token}}'},
              success: function(response) {}
          });{% endcomment %}
    });

    this.wavesurfer.on('region-click', function (region, event) {
      console.log("clicked")
      console.log(region)
      setCurrentRegion(region.id)

      if (event.button == 0 && event.ctrlKey == false) {
        if ("tags" in region.attributes){
          document.getElementById("tags").value = region.attributes['tags']
        } else {
          document.getElementById("tags").value = ""
        }
        if ("class" in region.attributes){
          $(select).val(region.attributes['class'])
        } else {
          select.selectedIndex = 0
        }
      } else if (event.button == 0 && event.ctrlKey == true) {
        region.remove()
      }
    });
  }

  $("#tag_button").click(function() {
    console.log('currentRegionID', annotator.currentRegionId)
		if (annotator.currentRegionId != -1) {
			var region = annotator.wavesurfer.regions.list[annotator.currentRegionId];
			var tags = document.getElementById("tags").value.split(",");
			region.update({
				attributes: {'class': region.attributes['class'],
    				 		 'tags': tags,
    				 		 'event_id': region.attributes['event_id']},
			});
			updateEvent(region);
		}
	});

  var annotator = new Annotator();
</script>
</body>
</html>
