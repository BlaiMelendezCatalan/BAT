{% extends 'annotation_tool/base_normal.html' %}

{% block title %}Annotation tool{% endblock %}

{% block header %}Annotation tool{% endblock %}

{% block body_block %}

<script src="https://cdnjs.cloudflare.com/ajax/libs/wavesurfer.js/1.2.4/wavesurfer.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/wavesurfer.js/1.2.3/plugin/wavesurfer.regions.min.js"></script>

<div id="waveform"></div>

<div style="text-align: center">
  <button class="btn btn-primary" onclick="wavesurfer.playPause()">
    <i class="glyphicon glyphicon-play"></i>
    Play
  </button>

  <p class="row">
    <div class="col-xs-1">
      <i class="glyphicon glyphicon-zoom-in"></i>
    </div>

    <div class="col-xs-10">
      <input id="slider" type="range" min="1" max="200" value="1" style="width: 100%" />
    </div>

    <div class="col-xs-1">
      <i class="glyphicon glyphicon-zoom-out"></i>
    </div>
  </p>
</div>
&nbsp;
<div>Class</div>

<select class="form-control" id="class_select" onchange="set_class()" style="width: auto;">
    <option value="" selected></option>
	{% for class in classes %}
    	<option value="{{ class.0 }}" >{{ class.0 }}</option>
	{% endfor %}
</select>
</form>
<div>Tags</div>
<input type="text" id="tags" value="">
<button id="tag_button">Save tags</button>

<form method="post" id='class_form' class="form-inline" action="javascript:save_annotation();">
<button type="submit" >Save annotation</button>
</form>

<form method="post" id='class_form' class="form-inline" action="javascript:delete_region();">
<button type="submit" >Delete region</button>
</form>

<script type="text/javascript">

	// WaveSurfer initialization
	function createBuffer(originalBuffer, duration) {
		var sampleRate = originalBuffer.sampleRate
		var frameCount = duration * sampleRate
		var channels = originalBuffer.numberOfChannels 
		return new AudioContext().createBuffer(channels, frameCount, sampleRate)
	}

	function copyBuffer(fromBuffer, fromStart, fromEnd, toBuffer, toStart) {
		var sampleRate = fromBuffer.sampleRate
		var frameCount = (fromEnd - fromStart) * sampleRate
		for (var i = 0; i < fromBuffer.numberOfChannels; i++) {
	    	var fromChanData = fromBuffer.getChannelData(i)
	    	var toChanData = toBuffer.getChannelData(i)
	    	for (var j = 0, f = Math.round(fromStart*sampleRate), t = Math.round(toStart*sampleRate); j < frameCount; j++, f++, t++) {
	        	toChanData[t] = fromChanData[f]
	    	}
		}
	}

	function loadRegions() {
        //for (var i = 0 ;i < events.length; i++) {
        {% for event in events %}
        	tags = []
        	{% for tag in event.tags.all %}
        		tags.push( '{{ tag.name }}' )
        	{% endfor %}
	        wavesurfer.addRegion({
	        	attributes: {'class': '{{ event.event_class }}',
	        				 'tags': tags },
	            start: {{ event.start_time }},
	            end: {{ event.end_time }},
	            color: "rgba(255, 0, 0, 0.2)",
	        });
	    {% endfor %}
    }

	var wavesurfer = WaveSurfer.create({
	    container: '#waveform',
	    waveColor: 'violet',
	    progressColor: 'purple',
	    normalize: true
	});

	wavesurfer.load("{% url 'media' segment.wav.name %}")

	var start = {{ segment.start_time }}
	var end = {{ segment.end_time }}
	var duration = end - start

	var isBufferCreated = 0
	var currentRegionId = -1

	wavesurfer.on('ready', function () {
		if (isBufferCreated == 0) {
			isBufferCreated = 1
			// create a new buffer to hold the new clip
			var buffer = createBuffer(wavesurfer.backend.buffer, duration)
			// copy
			copyBuffer(wavesurfer.backend.buffer, start, end, buffer, 0)
			// load the new buffer
			wavesurfer.empty()
			wavesurfer.loadDecodedBuffer(buffer)

			wavesurfer.enableDragSelection({})

			loadRegions()
		}
	});

	var slider = document.querySelector('#slider');

	slider.oninput = function () {
		var zoomLevel = Number(15 * slider.value);
		wavesurfer.zoom(zoomLevel);
	};

	// WaveSurfer callbacks
	wavesurfer.on('region-created', function (region) {
		currentRegionId = region.id
		document.getElementById("tags").value = ""
		select = document.getElementById("class_select")
		select.selectedIndex = 0
	});

	wavesurfer.on('region-click', function (region, event) {
		currentRegionId = region.id
		if ("tags" in region.attributes){
			document.getElementById("tags").value = region.attributes['tags']
		} else {
			document.getElementById("tags").value = ""
		}
		if ("class" in region.attributes){
			$(select).val(region.attributes['class'])
		} else {
			select.selectedIndex = 0
		}
	});

	// HTML elements callbacks
	$("#tag_button").click(function() {
		if (currentRegionId != -1) {
			region = wavesurfer.regions.list[currentRegionId]
			tags = document.getElementById("tags").value.split(",")
			region.attributes['tags'] = tags
		}
	});

    function save_annotation() {
    	regions_data = {}
    	Object.keys(wavesurfer.regions.list).forEach(function (id) {
    		region = wavesurfer.regions.list[id]
    		regions_data[id] = {}
    		regions_data[id]['start_time'] = region.start
    		regions_data[id]['end_time'] = region.end
    		regions_data[id]['event_class'] = region.attributes['class']
    		regions_data[id]['tags'] = region.attributes['tags']
    		regions_data[id]['annotation'] = '{{ annotation }}'
    	});

        $.ajax({
            type: "POST",
            url: '../save_annotation/',
            dataType: 'json',
            data: { regions_data: JSON.stringify(regions_data),
            		csrfmiddlewaretoken: '{{csrf_token}}'},
            success: function(response) {}
        });
    };

	function set_class() {
		if (currentRegionId != -1) {
			selected_class = document.getElementById("class_select");
			region_class = selected_class.options[selected_class.selectedIndex].value;
			region = wavesurfer.regions.list[currentRegionId]
			var class_dict = {{ class_dict|safe }};
			console.log(region)
			for (var i = 0; i < class_dict.length; i++) {
				if (class_dict[i][0] == region_class) {
					region.update({
						attributes: {
							class: region_class
						},
						color: class_dict[i][1]
					})
				}
			}
			console.log(region)
		}
	};

	function delete_region() {
		if (currentRegionId != -1) {
			region = wavesurfer.regions.list[currentRegionId]
			region.remove()
		}
	};

</script>

{% endblock %}